---
title: 一日一练-网络 CDN原理简单介绍
date: 2021-10-27 11:35:18
tags:
  - 技术
  - 一日一练
  - 网络
  - CDN
  - 转载
categories: 技术
---


本文转载自[知乎 CDN原理简单介绍](https://zhuanlan.zhihu.com/p/113037678)，有部分删节，看原文请到原地址。


## 一、简介
CDN 是将源站内容分发至全国所有的节点，从而缩短用户查看对象的延迟，提高用户访问网站的响应速度与网站的可用性的技术。它能够有效解决网络带宽小、用户访问量大、网点分布不均等问题。

>CDN 其实是 `Content Delivery Network` 的缩写，即“内容分发网络”
源站内容(image、html、js、css等) 这个属于内容分发
CDN 诞生于二十多年前，随着骨干网压力的逐渐增大，以及长传需求的逐渐增多，使得骨干网的压力越来越大，长传效果越来越差。


<!--more-->

于是在 1995 年，MIT 的应用数学教授 Tom Leighton 带领着研究生 Danny Lewin 和其他几位顶级研究人员一起尝试用数学问题解决网络拥堵问题。他们使用数学算法，处理内容的动态路由安排，并最终解决了困扰 Internet 使用者的难题。

## 二、CDN 作用
当下的互联网应用都包含大量的静态内容，但静态内容以及一些准动态内容又是最耗费带宽的，特别是针对全国甚至全世界的大型网站，如果这些请求都指向主站的服务器的话，不仅是主站服务器受不了，单端口 500M 左右的带宽也扛不住，所以大多数网站都需要 CDN 服务。

根本上的原因是，访问速度对互联网应用的用户体验、口碑、甚至说直接的营收都有巨大的影响，任何的企业都渴望自己站点有更快的访问速度。而 HTTP 传输时延对 web 的访问速度的影响很大，在绝大多数情况下是起决定性作用的，这是由 TCP/IP 协议的一些特点决定的。**物理层上的原因是光速有限、信道有限，协议上的原因有丢包、慢启动、拥塞控制等。**

这就是你使用 CDN 的第一个也是最重要的原因：**为了加速网站的访问。**

### 除了加速网站的访问之外，CDN还有一些作用：
#### 1. 为了实现跨运营商、跨地域的全网覆盖

互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN 加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署CDN边缘分发存储节点，充分利用带宽资源，平衡源站流量。

#### 2. 为了保障你的网站安全
CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。

#### 3. 为了异地备援
当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近100%的可靠性，这就让你的网站可以做到永不宕机。

#### 4. 为了节约成本
投入使用 CDN 加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管运维，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，节省了人力、精力和财力。

#### 5. 为了让你更专注业务本身
CDN 加速厂商一般都会提供一站式服务，业务不仅限于 CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供 7x24 运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。

{% asset_img 1.jpg %}

## 三、原理
### 通俗原理
{% asset_img 2.jpg %}

### 通过域名解析 IP 分析
{% asset_img 3.jpg %}

1. 当用户点击网站页面上的内容 URL，经过本地 DNS 系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。
2. CDN 的 DNS 服务器将 CDN 的**全局负载均衡设备** IP 地址返回用户。
3. 用户向 CDN 的**全局负载均衡设备**发起内容 URL 访问请求。
4. CDN **全局负载均衡设备**根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的区域负载均衡设备，告诉用户向这台设备发起请求。
5. 基于以下这些条件的综合分析之后，区域负载均衡设备会向**全局负载均衡设备**返回一台缓存服务器的 IP 地址：
6. 根据用户 IP 地址，判断哪一台服务器距用户最近；
7. 根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需内容；
8. 查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力。
9. **全局负载均衡设备**把服务器的 IP 地址返回给用户。
10. 用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。

## 三、常用的 CDN 缓存软件
* Varnish ：可以认为是内存缓存，速度一流，但是内存缓存也限制了其容量，缓存页面和图片一般是挺好的；
* squid 是功能最全面的比较传统的 web cache server，有自己的存储引擎。，但是架构太老，性能不怎样。
* nginx 本来是反向代理/ web 服务器，用了插件可以做做这个副业，但是本身不支持的功能比较多

## 四、使用场景
### 网站站点/应用加速
通俗讲就是 static 内容加速，静态内容加速，
如：html image js css 等

### 视音频点播/大文件下载分发加速
基本上都是视频点播，MP4、flv 等视频文件，
例如国内的优酷、土豆、腾讯视频、爱奇艺都是一样。

### 视频直播加速
视频直播加速，流媒体切片、转码、码流转换等等。
熊猫 TV、斗鱼、淘宝直播

### 移动应用加速
移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。
ios、安卓 端 APP 、微信小程序、支付宝小程序等。

## 五、题外
### 流量劫持
其实，CDN 本身就是一种 DNS 劫持，只不过是良性的。 不同于黑客强制 DNS 把域名解析到自己的钓鱼 IP 上，CDN 则是让 DNS 主动配合，把域名解析到临近的服务器上。

#### 劫持通常分为两类：
* 域名劫持，又称 DNS 劫持，通常是指域名指向到非正常 IP（恶意 IP），该恶意 IP 通过反向代理的方式，在能返回网页正常内容的情况，可能插入恶意代码、监听网民访问、劫持敏感信息等操作。通常验证一个域名是否被劫持的方法是 PING 一个域名，如果发现 PING 出来的 IP 不是您的服务器真实 IP，则可以确定被劫持了（当然如果使用了知道创宇云安全等安全加速平台，得到的IP为平台 IP，并非劫持）
* 数据劫持，通常由电信运营商中某些员工等勾结犯罪分子，在公网中进行数据支持，插入，此类情况极隐蔽，不会改变用户域名解析 IP，而是直接数据流经运营商宽带时在网页中挺入内容，此类情况，建议网页启用 HTTPS 加密，可以解决这一问题（通信是加密的，运营商无法插入恶意内容）

### 高仿、洗流量
CDN 可以通过分流 ，洗掉来自 Ddos 大部分的攻击 。