---
title: 一日一练-网络 使用 WireShark 分析 TCP/IP 三次握手和四次挥手
date: 2021-10-26 09:12:56
tags:
  - 技术
  - 一日一练
  - 网络
  - 转载
categories: 技术
---


本文转载自[cnblogs 使用 WireShark 分析 TCP/IP 三次握手 和 四次挥手](https://www.cnblogs.com/bylijian/p/8565601.html)，有部分删节，看原文请到原地址。

## 一、TCP 三次握手
{% asset_img 1.png %}

<!--more-->

### Wireshark 抓包注意事项
为了演示一个 TCP 三次握手建立连接的过程，我们通过 Chrome 访问一个网页。
已知 HTTP 协议就是建立在 TCP 链接上的

比如访问以下的网址：
`http://toutiao.newmedia139.net/`

通过 Cmd 的 ping 命令获取 这个网站对应的 IP 地址 `183.136.236.13`
{% asset_img 2.png %}

确定 这个IP 有一个非常重要的好处，就是我们只需要

电脑 -> 网站 的数据包

网站->电脑 的数据包

所以，可以使用Wireshark的显示过滤规则，只显示我们需要的数据，不然你一定看着满屏幕的数据抓狂的。

### 过滤规则如下：
`ip.src==183.136.236.13 or ip.dst==183.136.236.13`

### 截图：
{% asset_img 3.png %}

### 分析 TCP 握手包
### 概览
{% asset_img 4.png %}

通过图片，可以看到 先 进行了 TCP 三次传输 然后才 开始 HTTP 传输

#### 第一次 客户端发送 SYN 报文到服务器
{% asset_img 5.png %}

#### 第二次 ，服务器接收到客户端的 SYN 报文，回复 SYN + ACK 报文
{% asset_img 6.png %}

#### 第三次 ，客户端接收到服务端的 SYN+ACK 报文后，回复 ACK 报文
{% asset_img 7.png %}

### 注意：
这里有个坑：Wireshark 显示的 Syn Ack 的数目是不准确的
{% asset_img 8.png %}

理论上，Syn 应该初始值是个随机数的，后面的要根据初始值增加
{% asset_img 9.png %}

### TCP 三次握手总结
建立一个稳定的 双向 连接，最少需要 几次 通信呢？
以打电话为例
小明 给小红 打电话
小明 ： 喂，小红 听得到么？
小红： 嗯，我听到你说话了，你能听到我么？
小明：我能听到你。

只有这三个传输都正确了，才能保障双方是 连通的

## 二、TCP 四次挥手
由于 TCP 连接是全双工的，因此每个方向都必须单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个 FIN 来终止这个方向的连接。收到一个 FIN 只意味着这一方向上没有数据流动，一个 TCP 连接在收到一个 FIN 后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。

TCP 的连接的拆除需要发送四个包，因此称为四次挥手(four-way handshake)。客户端或服务器均可主动发起挥手动作，在 socket 编程中，任何一方执行 `close()` 操作即可产生挥手操作。

（1）客户端 A 发送一个 FIN，用来关闭客户 A 到服务器 B 的数据传送。

（2）服务器 B 收到这个FIN，它发回一个 ACK，确认序号为收到的序号加 1。和 SYN 一样，一个 FIN 将占用一个序号。

（3）服务器 B 关闭与客户端 A 的连接，发送一个 FIN 给客户端 A。

（4）客户端 A 发回 ACK 报文确认，并将确认序号设置为收到序号加 1。

TCP 采用四次挥手关闭连接如图所示。
{% asset_img 10.png %}

### 抓包截图
{% asset_img 11.png %}

其中 `183.136.236.13` 是服务器的 ip
可以看到 这一次挥手是由 服务器 发起的

#### 第一次挥手 FIN + ACK
{% asset_img 12.png %}

#### 第二次挥手 ACK
{% asset_img 13.png %}

#### 第三次挥手 FIN + ACK
{% asset_img 14.png %}

#### 第四次挥手 ACK
{% asset_img 15.png %}

### 总结
TCP 由于是全双工的，断开链接需要四次挥手



